{% extends "base.html" %}

{% load simple_rate %}
{% load i18n %}
{% load static %}

{% with object as idea %}

{% block content %}
  
<div class="thumbnail">
  <h3 style="margin-left:1%;">{{ idea.title }}</h3>
  <p class="text-muted" style="margin-left:1%">{% trans "Published on" %} {{ idea.created }}</p>
  <hr>
  <div style="margin-top:1%"></div>
  <div class="caption" style="float:right;">
    <div class="rate-box" style="margin-left:12%">
      <div id="idea-rating">{% get_rating idea %}</div>
    </div>
    <center style="margin-top:-3%">
      <a onclick="vote_idea_up({{ idea.id }})" class="btn btn-lg"><span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span></a>
      <a onclick="vote_idea_down({{ idea.id }})" class="btn btn-lg" style="margin-left:-20%;"><span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span></a>
    </center>
  </div>

  <p style="margin-left:1%">
    {{ idea.content }}
  </p>

  <div style="margin-top:1%"></div>

  <p style="margin-left:1%;margin-bottom:2%"><span style="color:red">{% trans "Source" %}</span>: <a href="">{{ idea.source }}</a></p>
    
   <div style="margin-bottom:1%"></div>
  
</div>

<div class="thumbnail">
  <h3 style="margin-left:1%">{% trans "Comments" %} ({{ idea.comments.count }})</h3>

  <t style="margin-left:1%;">{% trans "Sort by" %}:</t>
  <a href="">{% trans "Date" %}</a>
  <t> | </t>
  <a href="">{% trans "Rating" %}</a>

  <div class="comments" style="margin-top:1%;margin-left:1%">

    {% for comment in idea.comments.all %}

    <div class="comment-meta">
      <t class="text-muted" >#{{ comment.id }} </t>
      <b style="margin-left:1%;">{{ comment.author }}</b>
      Â·
      <t class="text-muted">{{ comment.created }}</t>
      <div style="float:right;color:#66CC33;margin-top:-0.3%">
	+10
	<a onclick="vote_idea_up({{ idea.id }})" class="btn btn-sm" style="margin-top:-5%;margin-left:-10%"><span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span></a>
	<a onclick="vote_idea_up({{ idea.id }})" class="btn btn-sm" style="margin-left:-25%"><span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span></a>
      </div>
    </div>

    <div class="comment-body" style="margin-left:1%;margin-top:1%">
      {{ comment.content|linebreaks }}

      {% if comment.replies.all %}
      <p style="margin-top:1%">
	<b>{% trans "Replies" %}: </b>

	{% for reply in comment.replies.all %}
	<a href="">#{{ reply.reply.id }}</a>
	{% endfor %}
      </p>
      {% endif %}

      
      <p><button onclick="reply({{ comment.id }})" style="margin-left:90%">Reply</button></p>
      
    </div>
    
    {% endfor %}

    <div id="new-comments-counter"></div>
    
  </div>

  <center>
    <h3 style="margin-left:1%;">{% trans "Post a new comment" %}</h3>
    <p style="margin-left:1%">{% trans "* as guest you can use your name or post anonymously" %}</p>
    <form class="comment-form" method="POST">{% csrf_token %}
      {{ form.errors }}
      <p><b>{% trans "Your name" %}</b>: {{ form.author }}</p>
      <p>{{ form.content }}</p>
      <input type="hidden" id="reply_id" name="reply_id" />
      <input id="comment-submit" type="submit" value="Submit" />
    </form>
  </center>
  
</div>


{% endblock content %}

{% block js %}

<script type="text/javascript">
  var ws = new WebSocket("ws://localhost:8888/comments/{{ idea.id }}");

  var new_message_text = "{% trans 'New comments' %}";
  var new_message_count = 0;
  
  ws.onmessage = function (message) {
      if (message.data == "NC"){
          new_message_count += 1;
          $("#new-comments-counter").text(new_message_text + ": " + new_message_count);
          $("#new-comments-counter").show();
      }
  };
  
  $("#id_content").attr("placeholder", "Type your text here");
  $("#id_content").show();
  $("#new-comments-counter").hide();

  function reply(comment_id) {
      $("#reply_id").val(comment_id);
      $("#id_content").text("#"+comment_id+"\n");
      $("#id_content").show();
  };

  $("#comment-submit").click(function() {
      ws.send("NC")
  });
  
</script>

{% endblock js %}
{% endwith %}
